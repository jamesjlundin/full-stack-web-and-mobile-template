# CI Pipeline for the monorepo
# Runs install, typecheck, lint, and web build on every push/PR

name: CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup pnpm before Node.js to enable pnpm caching in setup-node
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # Version is read from package.json packageManager field

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Typecheck
        run: pnpm tsc --noEmit

      - name: Lint
        run: pnpm eslint .

      - name: Build web app
        run: pnpm -C apps/web build

      # Optional: Run mobile tests if they exist
      - name: Run mobile tests (optional)
        run: pnpm -C apps/mobile test || echo "mobile tests optional"

      # -------------------------------------------------------------------
      # FUTURE: Adding database and migrations for auth/DB tests
      # -------------------------------------------------------------------
      # To run tests that require a database, add a Postgres service and
      # migration step. Example configuration:
      #
      # services:
      #   postgres:
      #     image: postgres:16
      #     env:
      #       POSTGRES_USER: test
      #       POSTGRES_PASSWORD: test
      #       POSTGRES_DB: test_db
      #     ports:
      #       - 5432:5432
      #     options: >-
      #       --health-cmd="pg_isready -U test"
      #       --health-interval=10s
      #       --health-timeout=5s
      #       --health-retries=5
      #
      # Then add these steps before running auth/DB tests:
      #
      # - name: Set DATABASE_URL
      #   run: echo "DATABASE_URL=postgresql://test:test@localhost:5432/test_db" >> $GITHUB_ENV
      #
      # - name: Run database migrations
      #   run: pnpm -C packages/db migrate:apply
      # -------------------------------------------------------------------
